local rednet = require("rednet")
local serverDir = "server_files"

-- Initialize the server and create necessary directories
if not fs.exists(serverDir) then
    fs.makeDir(serverDir)
end

-- Handle upload requests
local function handleUpload(senderID, message)
    local fileName, fileContent = message:match("([^,]+),(.+)")
    local filePath = fs.combine(serverDir, fileName)
    
    local file = fs.open(filePath, "w")
    file.write(fileContent)
    file.close()
    
    print("Received and saved file:", fileName)
    rednet.send(senderID, "Upload successful", "upload_response")
end

-- Handle download requests
local function handleDownload(senderID, fileName)
    local filePath = fs.combine(serverDir, fileName)
    
    if fs.exists(filePath) then
        local file = fs.open(filePath, "r")
        local fileContent = file.readAll()
        file.close()
        
        rednet.send(senderID, fileContent, "file_content")
        print("Sent file:", fileName)
    else
        rednet.send(senderID, "File not found", "file_content")
        print("Requested file not found:", fileName)
    end
end

-- Start the server
local function startServer()
    rednet.open("right")
    print("Server initialized. Ready to receive files.")
    
    while true do
        local event, senderID, protocol, message = os.pullEvent("modem_message")
        if protocol == "upload" then
            handleUpload(senderID, message)
        elseif protocol == "download" then
            handleDownload(senderID, message)
        end
    end
    
    rednet.close("right")
end

startServer()
