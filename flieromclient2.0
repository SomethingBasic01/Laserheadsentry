-- Upload a program to the server
local function uploadProgram(fileName)
    local filePath = fs.combine("", fileName)
    if not fs.exists(filePath) then
        print("File not found:", fileName)
        return
    end

    local file = fs.open(filePath, "r")
    local fileContent = file.readAll()
    file.close()

    rednet.open("right")
    rednet.broadcast(fileName .. "," .. fileContent, "upload")
    
    local timeout = os.startTimer(5)  -- 5 second timeout
    while true do
        local event, param1, param2, param3 = os.pullEvent()
        
        if event == "modem_message" then
            local senderID, protocol, response = param1, param2, param3
            if protocol == "upload_response" then
                print(response)
                break
            end
        elseif event == "timer" and param1 == timeout then
            print("Upload response timed out")
            break
        end
    end
    
    rednet.close("right")
    print("Uploaded file:", fileName)
end

-- Download a program from the server
local function downloadProgram(fileName)
    rednet.open("right")
    rednet.broadcast(fileName, "download")
    
    local timeout = os.startTimer(5)  -- 5 second timeout
    while true do
        local event, param1, param2, param3 = os.pullEvent()
        
        if event == "modem_message" then
            local senderID, protocol, fileContent = param1, param2, param3
            if protocol == "file_content" then
                if fileContent ~= "File not found" then
                    local filePath = fs.combine("", fileName)
                    local file = fs.open(filePath, "w")
                    file.write(fileContent)
                    file.close()
                    
                    print("Downloaded file:", fileName)
                else
                    print("File not found on server")
                end
                break
            end
        elseif event == "timer" and param1 == timeout then
            print("Download response timed out")
            break
        end
    end
    
    rednet.close("right")
end

-- List available files on the server
local function listFiles()
    rednet.open("right")
    rednet.broadcast("", "list_files")
    
    local timeout = os.startTimer(5)  -- 5 second timeout
    while true do
        local event, param1, param2, param3 = os.pullEvent()
        
        if event == "modem_message" then
            local senderID, protocol, fileList = param1, param2, param3
            if protocol == "file_list" then
                local files = {}
                for file in string.gmatch(fileList, '([^,]+)') do
                    table.insert(files, file)
                end
                
                print("Available files:")
                for _, file in ipairs(files) do
                    print(file)
                end
                break
            end
        elseif event == "timer" and param1 == timeout then
            print("List files response timed out")
            break
        end
    end
    
    rednet.close("right")
end

-- User interface to choose between upload, download, and listing files
local function main()
    print("Do you want to (1) upload, (2) download, or (3) list available files?")
    local choice = read()
    
    if choice == "1" then
        print("Enter the file name to upload:")
        local fileName = read()
        
        uploadProgram(fileName)
    elseif choice == "2" then
        print("Enter the file name to download:")
        local fileName = read()
        
        downloadProgram(fileName)
    elseif choice == "3" then
        listFiles()
    else
        print("Invalid choice")
    end
end

main()
